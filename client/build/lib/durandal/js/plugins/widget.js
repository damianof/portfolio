define(["durandal/system","durandal/composition","jquery","knockout"],function(t,e,n,i){function r(t,n){var r=i.utils.domData.get(t,u);r||(r={parts:e.cloneNodes(i.virtualElements.childNodes(t))},i.virtualElements.emptyNode(t),i.utils.domData.set(t,u,r)),n.parts=r.parts}var o={},a={},s=["model","view","kind"],u="durandal-widget-data",c={getSettings:function(e){var n=i.utils.unwrapObservable(e())||{};if(t.isString(n))return{kind:n};for(var r in n)n[r]=-1!=i.utils.arrayIndexOf(s,r)?i.utils.unwrapObservable(n[r]):n[r];return n},registerKind:function(t){i.bindingHandlers[t]={init:function(){return{controlsDescendantBindings:!0}},update:function(e,n,i,o,a){var s=c.getSettings(n);s.kind=t,r(e,s),c.create(e,s,a,!0)}},i.virtualElements.allowedBindings[t]=!0,e.composeBindings.push(t+":")},mapKind:function(t,e,n){e&&(a[t]=e),n&&(o[t]=n)},mapKindToModuleId:function(t){return o[t]||c.convertKindToModulePath(t)},convertKindToModulePath:function(t){return"widgets/"+t+"/viewmodel"},mapKindToViewId:function(t){return a[t]||c.convertKindToViewPath(t)},convertKindToViewPath:function(t){return"widgets/"+t+"/view"},createCompositionSettings:function(t,e){return e.model||(e.model=this.mapKindToModuleId(e.kind)),e.view||(e.view=this.mapKindToViewId(e.kind)),e.preserveContext=!0,e.activate=!0,e.activationData=e,e.mode="templated",e},create:function(t,n,i,r){r||(n=c.getSettings(function(){return n},t));var o=c.createCompositionSettings(t,n);e.compose(t,o,i)},install:function(t){if(t.bindingName=t.bindingName||"widget",t.kinds)for(var n=t.kinds,o=0;o<n.length;o++)c.registerKind(n[o]);i.bindingHandlers[t.bindingName]={init:function(){return{controlsDescendantBindings:!0}},update:function(t,e,n,i,o){var a=c.getSettings(e);r(t,a),c.create(t,a,o,!0)}},e.composeBindings.push(t.bindingName+":"),i.virtualElements.allowedBindings[t.bindingName]=!0}};return c});