define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(t,e,n,i,r,o,a,s){function c(t){return t=t.replace(m,"\\$&").replace(p,"(?:$1)?").replace(g,function(t,e){return e?t:"([^/]+)"}).replace(h,"(.*?)"),new RegExp("^"+t+"$")}function u(t){var e=t.indexOf(":"),n=e>0?e-1:t.length;return t.substring(0,n)}function l(t,e){return-1!==t.indexOf(e,t.length-e.length)}function d(t,e){if(!t||!e)return!1;if(t.length!=e.length)return!1;for(var n=0,i=t.length;i>n;n++)if(t[n]!=e[n])return!1;return!0}var f,v,p=/\((.*?)\)/g,g=/(\(\?)?:\w+/g,h=/\*\w+/g,m=/[\-{}\[\]+?.,\\\^$|#\s]/g,y=/\/$/,b=function(){function r(t){return t.router&&t.router.parent==j}function s(t){E&&E.config.isActive&&E.config.isActive(t)}function p(e,n){t.log("Navigation Complete",e,n);var i=t.getModuleId(T);i&&j.trigger("router:navigation:from:"+i),T=e,s(!1),E=n,s(!0);var o=t.getModuleId(T);o&&j.trigger("router:navigation:to:"+o),r(e)||j.updateDocumentTitle(e,n),v.explicitNavigation=!1,v.navigatingBack=!1,j.trigger("router:navigation:complete",e,n,j)}function g(e,n){t.log("Navigation Cancelled"),j.activeInstruction(E),E&&j.navigate(E.fragment,!1),C(!1),v.explicitNavigation=!1,v.navigatingBack=!1,j.trigger("router:navigation:cancelled",e,n,j)}function h(e){t.log("Navigation Redirecting"),C(!1),v.explicitNavigation=!1,v.navigatingBack=!1,j.navigate(e,{trigger:!0,replace:!0})}function m(e,n,i){v.navigatingBack=!v.explicitNavigation&&T!=i.fragment,j.trigger("router:route:activating",n,i,j),e.activateItem(n,i.params).then(function(t){if(t){var o=T;if(p(n,i),r(n)){var a=i.fragment;i.queryString&&(a+="?"+i.queryString),n.router.loadUrl(a)}o==n&&(j.attached(),j.compositionComplete())}else e.settings.lifecycleData&&e.settings.lifecycleData.redirect?h(e.settings.lifecycleData.redirect):g(n,i);f&&(f.resolve(),f=null)}).fail(function(e){t.error(e)})}function w(e,n,i){var r=j.guardRoute(n,i);r?r.then?r.then(function(r){r?t.isString(r)?h(r):m(e,n,i):g(n,i)}):t.isString(r)?h(r):m(e,n,i):g(n,i)}function x(t,e,n){j.guardRoute?w(t,e,n):m(t,e,n)}function k(t){return E&&E.config.moduleId==t.config.moduleId&&T&&(T.canReuseForRoute&&T.canReuseForRoute.apply(T,t.params)||!T.canReuseForRoute&&T.router&&T.router.loadUrl)}function I(){if(!C()){var e=D.shift();D=[],e&&(C(!0),j.activeInstruction(e),k(e)?x(n.create(),T,e):t.acquire(e.config.moduleId).then(function(n){var i=t.resolveObject(n);x(P,i,e)}).fail(function(n){t.error("Failed to load routed module ("+e.config.moduleId+"). Details: "+n.message)}))}}function S(t){D.unshift(t),I()}function A(t,e,n){for(var i=t.exec(e).slice(1),r=0;r<i.length;r++){var o=i[r];i[r]=o?decodeURIComponent(o):null}var a=j.parseQueryString(n);return a&&i.push(a),{params:i,queryParams:a}}function _(e){j.trigger("router:route:before-config",e,j),t.isRegExp(e)?e.routePattern=e.route:(e.title=e.title||j.convertRouteToTitle(e.route),e.moduleId=e.moduleId||j.convertRouteToModuleId(e.route),e.hash=e.hash||j.convertRouteToHash(e.route),e.routePattern=c(e.route)),e.isActive=e.isActive||a.observable(!1),j.trigger("router:route:after-config",e,j),j.routes.push(e),j.route(e.routePattern,function(t,n){var i=A(e.routePattern,t,n);S({fragment:t,queryString:n,config:e,params:i.params,queryParams:i.queryParams})})}function O(e){if(t.isArray(e.route))for(var n=e.isActive||a.observable(!1),i=0,r=e.route.length;r>i;i++){var o=t.extend({},e);o.route=e.route[i],o.isActive=n,i>0&&delete o.nav,_(o)}else _(e);return j}var T,E,D=[],C=a.observable(!1),P=n.create(),j={handlers:[],routes:[],navigationModel:a.observableArray([]),activeItem:P,isNavigating:a.computed(function(){var t=P(),e=C(),n=t&&t.router&&t.router!=j&&t.router.isNavigating()?!0:!1;return e||n}),activeInstruction:a.observable(null),__router__:!0};return i.includeIn(j),P.settings.areSameItem=function(t,e,n,i){return t==e?d(n,i):!1},j.parseQueryString=function(t){var e,n;if(!t)return null;if(n=t.split("&"),0==n.length)return null;e={};for(var i=0;i<n.length;i++){var r=n[i];if(""!==r){var o=r.split("=");e[o[0]]=o[1]&&decodeURIComponent(o[1].replace(/\+/g," "))}}return e},j.route=function(t,e){j.handlers.push({routePattern:t,callback:e})},j.loadUrl=function(e){var n=j.handlers,i=null,r=e,a=e.indexOf("?");if(-1!=a&&(r=e.substring(0,a),i=e.substr(a+1)),j.relativeToParentRouter){var s=this.parent.activeInstruction();r=s.params.join("/"),r&&"/"==r.charAt(0)&&(r=r.substr(1)),r||(r=""),r=r.replace("//","/").replace("//","/")}r=r.replace(y,"");for(var c=0;c<n.length;c++){var u=n[c];if(u.routePattern.test(r))return u.callback(r,i),!0}return t.log("Route Not Found"),j.trigger("router:route:not-found",e,j),E&&o.navigate(E.fragment,{trigger:!1,replace:!0}),v.explicitNavigation=!1,v.navigatingBack=!1,!1},j.updateDocumentTitle=function(t,n){n.config.title?document.title=e.title?n.config.title+" | "+e.title:n.config.title:e.title&&(document.title=e.title)},j.navigate=function(t,e){return t&&-1!=t.indexOf("://")?(window.location.href=t,!0):(v.explicitNavigation=!0,o.navigate(t,e))},j.navigateBack=function(){o.navigateBack()},j.attached=function(){j.trigger("router:navigation:attached",T,E,j)},j.compositionComplete=function(){C(!1),j.trigger("router:navigation:composition-complete",T,E,j),I()},j.convertRouteToHash=function(t){if(j.relativeToParentRouter){var e=j.parent.activeInstruction(),n=e.config.hash+"/"+t;return o._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/")}return o._hasPushState?t:"#"+t},j.convertRouteToModuleId=function(t){return u(t)},j.convertRouteToTitle=function(t){var e=u(t);return e.substring(0,1).toUpperCase()+e.substring(1)},j.map=function(e,n){if(t.isArray(e)){for(var i=0;i<e.length;i++)j.map(e[i]);return j}return t.isString(e)||t.isRegExp(e)?(n?t.isString(n)&&(n={moduleId:n}):n={},n.route=e):n=e,O(n)},j.buildNavigationModel=function(e){for(var n=[],i=j.routes,r=e||100,o=0;o<i.length;o++){var a=i[o];a.nav&&(t.isNumber(a.nav)||(a.nav=++r),n.push(a))}return n.sort(function(t,e){return t.nav-e.nav}),j.navigationModel(n),j},j.mapUnknownRoutes=function(e,n){var i="*catchall",r=c(i);return j.route(r,function(a,s){var c=A(r,a,s),u={fragment:a,queryString:s,config:{route:i,routePattern:r},params:c.params,queryParams:c.queryParams};if(e)if(t.isString(e))u.config.moduleId=e,n&&o.navigate(n,{trigger:!1,replace:!0});else if(t.isFunction(e)){var l=e(u);if(l&&l.then)return l.then(function(){j.trigger("router:route:before-config",u.config,j),j.trigger("router:route:after-config",u.config,j),S(u)}),void 0}else u.config=e,u.config.route=i,u.config.routePattern=r;else u.config.moduleId=a;j.trigger("router:route:before-config",u.config,j),j.trigger("router:route:after-config",u.config,j),S(u)}),j},j.reset=function(){return E=T=void 0,j.handlers=[],j.routes=[],j.off(),delete j.options,j},j.makeRelative=function(e){return t.isString(e)&&(e={moduleId:e,route:e}),e.moduleId&&!l(e.moduleId,"/")&&(e.moduleId+="/"),e.route&&!l(e.route,"/")&&(e.route+="/"),e.fromParent&&(j.relativeToParentRouter=!0),j.on("router:route:before-config").then(function(t){e.moduleId&&(t.moduleId=e.moduleId+t.moduleId),e.route&&(t.route=""===t.route?e.route.substring(0,e.route.length-1):e.route+t.route)}),j},j.createChildRouter=function(){var t=b();return t.parent=j,t},j};return v=b(),v.explicitNavigation=!1,v.navigatingBack=!1,v.targetIsThisWindow=function(t){var e=s(t.target).attr("target");return!e||e===window.name||"_self"===e||"top"===e&&window===window.top?!0:!1},v.activate=function(e){return t.defer(function(n){if(f=n,v.options=t.extend({routeHandler:v.loadUrl},v.options,e),o.activate(v.options),o._hasPushState)for(var i=v.routes,r=i.length;r--;){var a=i[r];a.hash=a.hash.replace("#","")}s(document).delegate("a","click",function(t){if(o._hasPushState){if(!t.altKey&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey&&v.targetIsThisWindow(t)){var e=s(this).attr("href");null==e||"#"===e.charAt(0)||/^[a-z]+:/i.test(e)||(v.explicitNavigation=!0,t.preventDefault(),o.navigate(e))}}else v.explicitNavigation=!0}),o.options.silent&&f&&(f.resolve(),f=null)}).promise()},v.deactivate=function(){o.deactivate()},v.install=function(){a.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(t,e,n,i,o){var s=a.utils.unwrapObservable(e())||{};if(s.__router__)s={model:s.activeItem(),attached:s.attached,compositionComplete:s.compositionComplete,activate:!1};else{var c=a.utils.unwrapObservable(s.router||i.router)||v;s.model=c.activeItem(),s.attached=c.attached,s.compositionComplete=c.compositionComplete,s.activate=!1}r.compose(t,s,o)}},a.virtualElements.allowedBindings.router=!0},v});