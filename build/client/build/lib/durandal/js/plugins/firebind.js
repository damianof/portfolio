define(["knockout"],function(t){var e=function(){var e=function(e){var i=JSON.parse(t.toJSON(e));return i},i=function(t,e,i){for(var n,r=0;r<t.length;r++)if(t[r][e]===i){n=t[r];break}return n},n=function(t,e){var i=t.child(e);return null!=i&&i.remove(),i},r=function(t){return!isNaN(parseFloat(t))&&isFinite(t)};t.fireSet=function(o,a,s){var c=t.observableArray(),s=s||{},u=s.id||"id",l=s.orderBy,d={},f=c.push,v=c.remove,p=c.splice,h=c.unshift;return o.on("child_added",function(t,e){var n=t.name(),r=t.val(),s=new a(n,r,o.child(n));if(d[n]=t.getPriority(),void 0===e)f.call(c,s);else if(null===e)h.call(c,s);else{var l=c(),v=i(l,u,e),m=l.indexOf(v);p.call(c,m+1,0,s)}}),o.on("child_moved",function(t,e){var n=t.name();items=c.peek(),setItem=i(items,u,n),oldIndex=items.indexOf(setItem),a=0,d[n]=t.getPriority();var r=p.call(c,oldIndex,1)[0];if(null!==e)var o=i(items,u,e),a=items.indexOf(o)+1;p.call(c,a,0,r)}),o.on("child_removed",function(t){var e=t.name(),n=c(),r=i(n,u,e);delete d[e],v.call(c,r)}),c.push=function(){var i=Array.prototype.slice.call(arguments),n=c.peek();if(l)i.forEach(function(i){o.push().setWithPriority(e(i),t.unwrap(i[l]))});else{var a=0;if(n.length){var s=n[n.length-1];a=d[t.unwrap(s[u])],a=r(a)?Math.ceil(a):0}i.forEach(function(t){a++,o.push().setWithPriority(e(t),a)})}return n.length+arguments.length},c.pop=function(){var e=c.peek(),i=e[e.length-1];return n(o,t.unwrap(i[u])),i},c.shift=function(){var e=c.peek()[0];return n(o,t.unwrap(e[u])),e},c.unshift=function(){var i=c.peek(),n=Array.prototype.slice.call(arguments);if(l)n.forEach(function(i){o.push().setWithPriority(e(i),t.unwrap(i[l]))});else if(i.length){var r=i[0],a=d[t.unwrap(r[u])],s=a/2;n.forEach(function(t){o.push().setWithPriority(e(t),s),s=(s+a)/2})}else{var s=0;n.forEach(function(t){s++,o.push().setWithPriority(e(t),s)})}return i.length+arguments.length},c.remove=function(e){var i=c.peek(),r=[],a="function"!=typeof e||t.isObservable(e)?function(t){return t===e}:e;return i.forEach(function(t){a(t)&&(n(o,t[u]),r.push(t))}),r},c.removeAll=function(e){return void 0===e?(o.remove(),c().slice(0)):c.remove(function(i){return t.utils.arrayIndexOf(e,i)>=0})},c.sort=function(e){if(l&&!e)return c.peek();e=e&&"function"==typeof e||function(i,n){return e?t.unwrap(i[e])>t.unwrap(n[e])?1:-1:d[t.unwrap(i[u])]>d[t.unwrap(n[u])]?1:-1};var i=c.peek(),n=Math.floor(d[t.unwrap(i[0][u])]),r=i.slice(0).sort(e);r.forEach(function(e){o.child(t.unwrap(e[u])).setPriority(n),n++})},c.reverse=function(){if(l)throw new Error("You cannot reverse a fireSet that is sorted on a property.");c.sort(function(e,i){return t.unwrap(e[sorter])>t.unwrap(i[sorter])?-1:1})},c.move=function(e,i){var n=c.peek(),r=n[e],a=n.length,s=o.child(t.unwrap(r[u])),l=e>i;if(!(2>a))if(0>i?i=(i%a+a)%a:i>=a&&(i=0),0===i){var f=d[t.unwrap(n[0][u])];s.setPriority(Math.floor(f-1))}else if(i===a-1){var v=d[t.unwrap(n[i][u])];s.setPriority(Math.ceil(v+1))}else{var p=n[l?i-1:i],h=n[l?i:i+1],m=d[t.unwrap(p[u])];rightPriority=d[t.unwrap(h[u])],newPriority=(m+rightPriority)/2,s.setPriority(newPriority)}},c.splice=function(){throw new Error("Splice is not currently implemented. You can use move or remove.")},c},t.fireModel=function(e,i,n){var r=Object.keys(i);r.forEach(function(i){var r=t.observable(),o=n.child(i);o.on("value",function(t){r(t.val())}),e[i]=t.computed({read:r,write:function(t){o.set(t)}})})}};return{install:e}});