define(["knockout","jquery"],function(t,e){return{install:function(){function i(t,i){var n=document.createElementNS("http://www.w3.org/2000/svg",t||"svg");return i&&e.each(i,function(t,e){n.setAttributeNS(null,t,e)}),e(n)}e.fn.activity=function(t){return this.each(function(){var i=e(this),a=i.data("activity");if(a&&(clearInterval(a.data("interval")),a.remove(),i.removeData("activity")),t!==!1){t=e.extend({color:i.css("color")},e.fn.activity.defaults,t),a=n(i,t).css("position","absolute").prependTo(t.outside?"body":i);var o=i.outerHeight()-a.height(),s=i.outerWidth()-a.width(),c=i.offset(),l={top:"top"==t.valign?t.padding:"bottom"==t.valign?o-t.padding:Math.floor(o/2),left:"left"==t.align?t.padding:"right"==t.align?s-t.padding:Math.floor(s/2)};t.outside?a.css({top:c.top+"px",left:c.left+"px"}):(l.top-=a.offset().top-c.top,l.left-=a.offset().left-c.left),a.css({marginTop:l.top+"px",marginLeft:l.left+"px"}),r(a,t.segments,Math.round(10/t.speed)/10),i.data("activity",a)}}),this},e.fn.activity.defaults={segments:12,space:3,length:7,width:4,speed:1.2,align:"center",valign:"center",padding:4},e.fn.activity.getOpacity=function(t,e){var i=t.steps||t.segments-1,n=void 0!==t.opacity?t.opacity:1/i;return 1-Math.min(e,i)*(1-n)/i};var n=function(){return e("<div>").addClass("busy")},r=function(){};if(document.createElementNS&&document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect)if(n=function(t,n){for(var r=2*n.width+n.space,a=r+n.length+Math.ceil(n.width/2)+1,o=i().width(2*a).height(2*a),s=i("g",{"stroke-width":n.width,"stroke-linecap":"round",stroke:n.color}).appendTo(i("g",{transform:"translate("+a+","+a+")"}).appendTo(o)),c=0;c<n.segments;c++)s.append(i("line",{x1:0,y1:r,x2:0,y2:r+n.length,transform:"rotate("+360/n.segments*c+", 0, 0)",opacity:e.fn.activity.getOpacity(n,c)}));return e("<div>").append(o).width(2*a).height(2*a)},void 0!==document.createElement("div").style.WebkitAnimationName){var a={};r=function(t,e,i){if(!a[e]){for(var n="spin"+e,r="@-webkit-keyframes "+n+" {",o=0;e>o;o++){var s=Math.round(1e5/e*o)/1e3,c=Math.round(1e5/e*(o+1)-1)/1e3,l="% { -webkit-transform:rotate("+Math.round(360/e*o)+"deg); }\n";r+=s+l+c+l}r+="100% { -webkit-transform:rotate(100deg); }\n}",document.styleSheets[0].insertRule(r,document.styleSheets[0].cssRules.length),a[e]=n}t.css("-webkit-animation",a[e]+" "+i+"s linear infinite")}}else r=function(t,e,i){var n=0,r=t.find("g g").get(0);t.data("interval",setInterval(function(){r.setAttributeNS(null,"transform","rotate("+ ++n%e*(360/e)+")")},1e3*i/e))};else{var o=e("<shape>").css("behavior","url(#default#VML)");if(e("body").append(o),o.get(0).adj){var s=document.createStyleSheet();e.each(["group","shape","stroke"],function(){s.addRule(this,"behavior:url(#default#VML);")}),n=function(t,i){for(var n=2*i.width+i.space,r=n+i.length+Math.ceil(i.width/2)+1,a=2*r,o=-Math.ceil(a/2),s=e("<group>",{coordsize:a+" "+a,coordorigin:o+" "+o}).css({top:o,left:o,width:a,height:a}),c=0;c<i.segments;c++)s.append(e("<shape>",{path:"m "+n+",0  l "+(n+i.length)+",0"}).css({width:a,height:a,rotation:360/i.segments*c+"deg"}).append(e("<stroke>",{color:i.color,weight:i.width+"px",endcap:"round",opacity:e.fn.activity.getOpacity(i,c)})));return e("<group>",{coordsize:a+" "+a}).css({width:a,height:a,overflow:"hidden"}).append(s)},r=function(t,e,i){var n=0,r=t.get(0);t.data("interval",setInterval(function(){r.style.rotation=++n%e*(360/e)},1e3*i/e))}}e(o).remove()}!function(t){"use strict";var e=function(t){this.$element=t,this.onlyIcon=1===this.$element.contents().length&&1===this.$element.children("i").length,this.activityText=this.$element.data("activity-text"),this.isIndicatorOnly=this.$element.is("i"),this.icons=this.$element.children("i")};e.prototype={createTemporaryIcon:function(){this.onlyIcon||(this.temporaryIcon=t('<i style="display: inline-block; padding-left: 5px; width: 14px;"></i>'),this.$element.append(this.temporaryIcon))},hideExistingIcons:function(){this.onlyIcon&&this.icons.css("visibility","hidden")},moveSpinnerToFront:function(){t("body > div, body > group").first().css("z-index",9999)},removeTemporaryIcon:function(){this.temporaryIcon&&(this.temporaryIcon.remove(),this.temporaryIcon=null)},setText:function(t){if(this.activityText){var e=this.$element.data(),i=this.$element.is("input")?"val":"html";"activity"===t&&this.$element.data("resetText",this.$element[i]()),this.$element[i](e[t+"Text"])}},showExistingIcons:function(){this.icons.css("visibility","visible")},start:function(){this.isBusy=!0,this.setText("activity"),this.createTemporaryIcon(),this.hideExistingIcons(),this.$element.is("button")&&this.$element.addClass("disabled").attr("disabled","disabled"),this.$element.activity({align:this.onlyIcon||this.isIndicatorOnly?"center":"right",length:this.isIndicatorOnly?5:2,padding:12,outside:!0,segments:this.isIndicatorOnly?12:10,space:this.isIndicatorOnly?2:1,width:1.5}),this.moveSpinnerToFront()},stop:function(){this.removeTemporaryIcon(),this.showExistingIcons(),this.isBusy=!1,this.setText("reset"),this.$element.activity(!1),this.$element.removeClass("disabled").removeAttr("disabled")},update:function(t){t&&!this.isBusy&&this.start(),!t&&this.isBusy&&this.stop()}},t.fn.activityEx=function(i){var n=function(e){if(!i)return e.activity(!1),void 0;var n=Math.round(e.height()/4),r=e.is("input");e.activity({align:e.is("input")?"right":"center",length:n,padding:r?n:0,outside:!0,segments:Math.max(10,10+(n-5)),space:1,width:1.5}),t("body > div").first().css("z-index",9999)},r=function(t){var n=t.data("activityEx");n||t.data("activityEx",n=new e(t)),n.update(i)};return this.each(function(){t(this).is("button, input, a")?r(t(this)):n(t(this))})}}(jQuery),t.bindingHandlers.activity={init:function(i){t.utils.domNodeDisposal.addDisposeCallback(i,function(){e(i).activityEx(!1)})},update:function(i,n){var r=t.utils.unwrapObservable(n()),a=e.isFunction(r)?r():r;"boolean"!=typeof a||e(i).activityEx(a)}}}}});